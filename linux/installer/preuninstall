#!/bin/bash

CM_SERVICE="csccloudmanagement"
PREFIX="/opt/cisco/secureclient"
CM_DIR="${PREFIX}/cloudmanagement"

# Function to log messages
log() {
    # Get epoch seconds and convert to readable format with seconds (Linux only)
    local epoch=$(date +%s)
    local datetime=$(date -d "@${epoch}" '+%Y-%m-%d %H:%M')
    local seconds=$((epoch % 60))
    local timestamp="${datetime}:$(printf '%02d' ${seconds})"
    echo "[${timestamp}] [PREUNINSTALL] $*"
}

log "Starting CM uninstallation process"
log "First argument (action): $1"

# Detect package manager and handle arguments accordingly
SHOULD_STOP_SERVICE=false

if command -v rpm &>/dev/null; then
    log "Detected RPM-based system"
    # RPM argument meanings:
    # $1 = 0: package is being removed/uninstalled
    # $1 = 1: package is being upgraded (old version being removed)
    
    if [ "$1" = "0" ]; then
        log "Package removal/uninstallation (RPM)"
        SHOULD_STOP_SERVICE=true
    else
        log "Package upgrade - service will remain running (RPM)"
    fi
elif command -v dpkg &>/dev/null; then
    log "Detected Debian-based system"
    # DPKG argument meanings:
    # $1 = "remove": package is being removed/uninstalled
    # $1 = "upgrade": package is being upgraded
    
    if [ "$1" = "remove" ]; then
        log "Package removal/uninstallation (DPKG)"
        SHOULD_STOP_SERVICE=true
    else
        log "Package upgrade - service will remain running (DPKG)"
    fi
else
    log "Unknown package manager - assuming removal"
    SHOULD_STOP_SERVICE=true
fi

# Stop and disable service only during actual uninstall (not upgrades)
if [ "$SHOULD_STOP_SERVICE" = "true" ]; then
    log "Stopping and disabling CM service"
    
    if systemctl is-active --quiet ${CM_SERVICE}; then
        log "Stopping CM service"
        systemctl stop ${CM_SERVICE}
        STOP_EXIT_CODE=$?
        if [ ${STOP_EXIT_CODE} -ne 0 ]; then
            log "Service stop failed with exit code: ${STOP_EXIT_CODE}"
        fi
        
        # Verify service stopped
        sleep 1
        if systemctl is-active --quiet ${CM_SERVICE}; then
            log "Warning: Service still appears to be active after stop command"
        fi
    fi
    
    SERVICE_ENABLED=$(systemctl is-enabled ${CM_SERVICE} 2>/dev/null || echo "unknown")
    if [ "${SERVICE_ENABLED}" = "enabled" ]; then
        systemctl disable ${CM_SERVICE}
        DISABLE_EXIT_CODE=$?
        if [ ${DISABLE_EXIT_CODE} -ne 0 ]; then
            log "Service disable failed with exit code: ${DISABLE_EXIT_CODE}"
        fi
    fi
    
    log "Service cleanup completed for uninstallation"
else
    log "Old package version being replaced during upgrade"
fi

log "Preuninstall operations completed"
exit 0