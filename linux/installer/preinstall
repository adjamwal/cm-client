#!/bin/bash

PREFIX="/opt/cisco/secureclient"
CM_DIR="${PREFIX}/cloudmanagement"
ETC_DIR="${CM_DIR}/etc"
TMP_DIR="${PREFIX}/tmp"
BOOTSTRAP_FILE="bs.json"
CM_CONFIG_FILE="cm_config.json"
CM_PACKAGE_ID="cisco-secure-client-cloudmanagement-client"

# RPM debug options
RPM_VERBOSE=8

# Function to log messages
log_message() {
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    # Remove any OURCE suffix that might appear
    timestamp=${timestamp%OURCE}
    local level="$1"
    shift
    echo "[${timestamp}] [${level}] [PREINSTALL] $*"
}

log_info() {
    log_message "INFO" "$@"
}

log_error() {
    log_message "ERROR" "$@"
}

log_debug() {
    if [ "${RPM_VERBOSE}" -gt 0 ]; then
        log_message "DEBUG" "$@"
    fi
}

log_trace() {
    if [ "${RPM_VERBOSE}" -gt 2 ]; then
        log_message "TRACE" "$@"
    fi
}

log_info "Installing Cisco Secure Client CM"

# Detect package manager and check for previous installation
if command -v rpm &>/dev/null; then
    log_info "Detected RPM-based system"
    
    if [ "${RPM_VERBOSE}" -gt 0 ]; then
        log_info "RPM verbose mode enabled (level ${RPM_VERBOSE})"
    fi
    
    log_debug "Searching for installed packages matching: ${CM_PACKAGE_ID}"
    INSTALLED=$(rpm -qa | grep -E "^${CM_PACKAGE_ID}-")
    
    if [[ -n "${INSTALLED}" ]]; then
        INSTALLED_VERSION=$(echo "${INSTALLED}" | sed -n 's/.*-\([0-9]\+\.[0-9]\+\.[0-9]\+\)-[0-9]\+\..*/\1/p')
        log_info "Found previous installation: ${INSTALLED}"
        log_debug "Previous installed version: ${INSTALLED_VERSION}"
        
        if [ "${RPM_VERBOSE}" -gt 1 ]; then
            INSTALL_DATE=$(rpm -q --qf "%{INSTALLTIME:date}" ${CM_PACKAGE_ID} 2>/dev/null)
            log_trace "Installation date: ${INSTALL_DATE}"
        fi
    else
        INSTALLED_VERSION="None"
        log_debug "No packages matching ${CM_PACKAGE_ID} found in RPM database"
    fi
elif command -v dpkg &>/dev/null; then
    log_info "Detected Debian-based system"
    
    INSTALLED=$(dpkg -l | awk '{print $2}' | grep -E "^${CM_PACKAGE_ID}$")
    
    if [[ -n "${INSTALLED}" ]]; then
        INSTALLED_VERSION=$(dpkg-query -W -f='${Version}' ${CM_PACKAGE_ID} 2>/dev/null | sed 's/-[0-9]\+$//')
        log_info "Found previous installation: ${INSTALLED}"
        log_debug "Previous installed version: ${INSTALLED_VERSION}"
    else
        INSTALLED_VERSION="None"
    fi
else
    log_error "Unsupported package manager. Exiting."
    exit 1
fi

# Backup configuration if previous installation exists
if [[ -n "${INSTALLED}" ]]; then
    log_info "Backing up configuration files to ${TMP_DIR}"
    
    rm -rf "${TMP_DIR}"
    mkdir -p "${TMP_DIR}"
    
    # Save version information for postinstall
    echo "${INSTALLED_VERSION}" > "${TMP_DIR}/cm_previous_version" 2>/dev/null || true
    
    # Backup configuration files
    if [ -f "${ETC_DIR}/${BOOTSTRAP_FILE}" ]; then
        cp -f "${ETC_DIR}/${BOOTSTRAP_FILE}" "${TMP_DIR}"
        log_info "Backed up ${BOOTSTRAP_FILE}"
        log_debug "Backed up bootstrap file from ${ETC_DIR}/${BOOTSTRAP_FILE}"
    else
        log_debug "Bootstrap file not found at ${ETC_DIR}/${BOOTSTRAP_FILE}"
    fi
    
    if [ -f "${ETC_DIR}/${CM_CONFIG_FILE}" ]; then
        cp -f "${ETC_DIR}/${CM_CONFIG_FILE}" "${TMP_DIR}"
        log_info "Backed up ${CM_CONFIG_FILE}"
        log_debug "Backed up config file from ${ETC_DIR}/${CM_CONFIG_FILE}"
    else
        log_debug "Config file not found at ${ETC_DIR}/${CM_CONFIG_FILE}"
    fi
    
    log_debug "Backup complete"
else
    # Create temp directory and save version info even for fresh installs
    mkdir -p "${TMP_DIR}" 2>/dev/null || true
    echo "${INSTALLED_VERSION}" > "${TMP_DIR}/cm_previous_version" 2>/dev/null || true
    log_debug "No previous installation found, skipping configuration backup"
fi

log_info "Preinstall operations completed successfully"
log_debug "Preinstall completed. Previous installed version: ${INSTALLED_VERSION}"
exit 0