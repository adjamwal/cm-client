#!/bin/bash

PREFIX="/opt/cisco/secureclient"
CM_DIR="${PREFIX}/cloudmanagement"
ETC_DIR="${CM_DIR}/etc"
TMP_DIR="${PREFIX}/tmp"
BOOTSTRAP_FILE="bs.json"
CM_CONFIG_FILE="cm_config.json"
CM_PACKAGE_ID="cisco-secure-client-cloudmanagement-client"

# Function to log messages
log() {
    # Get epoch seconds and convert to readable format with seconds (Linux only)
    local epoch=$(date +%s)
    local datetime=$(date -d "@${epoch}" '+%Y-%m-%d %H:%M')
    local seconds=$((epoch % 60))
    local timestamp="${datetime}:$(printf '%02d' ${seconds})"
    echo "[${timestamp}] [PREINSTALL] $*"
}

log "Installing Cisco Secure Client CM"

# Detect package manager and check for previous installation
if command -v rpm &>/dev/null; then
    log "Detected RPM-based system"
    INSTALLED=$(rpm -qa | grep -E "^${CM_PACKAGE_ID}-")
    
    if [[ -n "${INSTALLED}" ]]; then
        INSTALLED_VERSION=$(echo "${INSTALLED}" | sed -n 's/.*-\([0-9]\+\.[0-9]\+\.[0-9]\+\)-[0-9]\+\..*/\1/p')
        log "Found previous installation: ${INSTALLED}"
    else
        INSTALLED_VERSION="None"
        log "Fresh installation detected - no previous package found"
    fi
elif command -v dpkg &>/dev/null; then
    log "Detected Debian-based system"
    INSTALLED=$(dpkg -l | awk '{print $2}' | grep -E "^${CM_PACKAGE_ID}$")
    
    if [[ -n "${INSTALLED}" ]]; then
        INSTALLED_VERSION=$(dpkg-query -W -f='${Version}' ${CM_PACKAGE_ID} 2>/dev/null | sed 's/-[0-9]\+$//')
        log "Found previous installation: ${INSTALLED}"
    else
        INSTALLED_VERSION="None"
        log "Fresh installation detected"
    fi
else
    log "Unsupported package manager. Exiting."
    exit 1
fi

# Determine installation type
if [[ -n "${INSTALLED}" ]]; then
    log "This is an upgrade installation - previous version: ${INSTALLED_VERSION}"
else
    log "This is a fresh installation"
fi

# Get current package information before installation
if command -v rpm &>/dev/null; then
    log "Current package information from rpm -qi:"
    # Get any installed package matching the pattern
    PACKAGE=$(rpm -qa | grep "${CM_PACKAGE_ID}" | head -1)
    if [ -n "${PACKAGE}" ]; then
        rpm -qi ${PACKAGE} 2>/dev/null | while read line; do
            log "  $line"
        done
    else
        log "  Package not found in RPM database"
    fi
elif command -v dpkg &>/dev/null; then
    log "Current package information from dpkg -s:"
    dpkg -s ${CM_PACKAGE_ID} 2>/dev/null | while read line; do
        log "  $line"
    done
fi

# Backup configuration if previous installation exists
if [[ -n "${INSTALLED}" ]]; then
    log "Backing up configuration files to ${TMP_DIR}"
    
    rm -rf "${TMP_DIR}"
    mkdir -p "${TMP_DIR}"
    
    # Save version information for postinstall
    echo "${INSTALLED_VERSION}" > "${TMP_DIR}/cm_previous_version" 2>/dev/null || true
    
    # Backup configuration files
    if [ -f "${ETC_DIR}/${BOOTSTRAP_FILE}" ]; then
        cp -f "${ETC_DIR}/${BOOTSTRAP_FILE}" "${TMP_DIR}"
        log "Backed up bootstrap file"
    fi
    
    if [ -f "${ETC_DIR}/${CM_CONFIG_FILE}" ]; then
        cp -f "${ETC_DIR}/${CM_CONFIG_FILE}" "${TMP_DIR}"
        log "Backed up config file"
    fi
    
    log "Configuration backup process completed"
else
    # Create temp directory and save version info even for fresh installs
    mkdir -p "${TMP_DIR}" 2>/dev/null || true
    echo "${INSTALLED_VERSION}" > "${TMP_DIR}/cm_previous_version" 2>/dev/null || true
    log "Fresh installation - no configuration to backup"
fi

log "Preinstall operations completed successfully"